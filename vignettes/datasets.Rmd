---
title: "The Datasets and Relationships"
author: "Tim Trice"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The Datasets and Relationships}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      include = TRUE, 
                      fig.width = 7, 
                      fig.aspect = 0.5)
```

```{r, message = FALSE}
library(dplyr)
library(ggplot2)
library(NCDCStormEvents)
library(maps)
```

There are samples for each of the three datasets in raw format (unclean) included in `NCDCStormEvents`. Every `EVENT_ID` can be found in each dataset. 

```{r}
data(s.details)
data(s.fatalities)
data(s.locations)
```

While `EVENT_ID` is the primary key for `details` (root dataset) and `locations` (child dataset), an `EPISODE_ID` can have many `EVENT_ID` and can be considered the root variable. `FATALITY_ID` is the primary key in `fatalities`.

Let's build a tornado dataframe.

```{r}
tornadoes <- s.details %>% 
  filter(EVENT_TYPE == 'Tornado')
dim(tornadoes)
```

As these samples are of the raw data I won't show all of the variables here; the help files for each dataset contains some detailed information on each one.

`EVENT_ID` 574338 has reports of multiple injuries and fatalities in `EVENT_NARRATIVE`. In `details` there are four variables that should show such data: `INJURIES_DIRECT`, `INJURIES_INDIRECT`, `DEATHS_DIRECT` and `DEATHS_INDIRECT`. 

```{r}
tornadoes %>% 
  filter(EVENT_ID == 574338) %>% 
  select(EVENT_ID, INJURIES_DIRECT, INJURIES_INDIRECT, DEATHS_DIRECT, 
         DEATHS_INDIRECT)
```

Let's see what `fatalities` shows us for this `EVENT_ID`.

```{r}
s.fatalities %>% 
  filter(EVENT_ID == 574338) %>% 
  select(EVENT_ID, FATALITY_ID, FATALITY_TYPE, FATALITY_AGE, FATALITY_SEX, 
         FATALITY_LOCATION)
```

And what about `locations`:

```{r}
s.locations %>% 
  filter(EVENT_ID == 574338) %>% 
  select(EVENT_ID, RANGE, AZIMUTH, LOCATION, LATITUDE, LONGITUDE)
```

The `EVENT_NARRATIVE` should give us some more information on what happened.

```{r}
tornadoes %>% 
  filter(EVENT_ID == 574338) %>% 
  select(EVENT_NARRATIVE) %>% 
  first()
```

We can also view the `EPISODE_NARRATIVE` for this event.

```{r}
tornadoes %>% 
  filter(EVENT_ID == 574338) %>% 
  select(EPISODE_NARRATIVE) %>% 
  first()
```

Interestingly, we learn this was a pretty significant event with a fairly strong EF3 tornado which was the strongest tornado in the region in 25 years!

We should also be able to get some detailed information on the tornado itself.

```{r}
tornadoes %>% 
  filter(EVENT_ID == 574338) %>% 
  select(TOR_F_SCALE, TOR_LENGTH, TOR_WIDTH)
```

This tornado traveled about 5 miles and at one point was 700ft wide (0.13 miles). Out of curiosity, what are the stats on `TOR_LENGTH`?

```{r}
Hmisc::describe(tornadoes$TOR_LENGTH)
```

This tornado, as far as length traveled, really isn't impressive at all.

There are also damage statistics included in `details`.

```{r}
tornadoes %>% 
  filter(EVENT_ID == 574338) %>% 
  select(starts_with("DAMAGE"))
```

```{r}
Hmisc::describe(tornadoes$DAMAGE_PROPERTY)
```

In regards to cost of damage, though, for 2015 this was the costliest tornado, *it would seem*. Be careful though and remember that we are dealing with dirty data here. And `DAMAGE_PROPERTY` is a character field. This needs to be cleaned up to really see where this tornado stands cost-wise.

You can use any of the cleaning functions at any time. These cleaning functions have a prefix that identifies the dataset for which they're built. In this instance, I'll use `details_damages`.

```{r}
dp <- details_damages(tornadoes %>% 
                        select(EVENT_ID, DAMAGE_PROPERTY))
```

Now let's see the true stats.

```{r}
Hmisc::describe(dp$DAMAGE_PROPERTY)
```

With the tornado costing $8M that puts it between the 25th and 50th percentile. That's pretty significant, but for all tornadoes of 2015 alone there were much worse.


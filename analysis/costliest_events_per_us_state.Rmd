---
title: "Costliest Events per U.S. State"
author: "Tim Trice"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: inline
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = TRUE, 
  error = TRUE, 
  fig.width = 10, 
  fig.asp = 1, 
  fig.dpi = 180
)
```

```{r libraries}
library(DBI)
library(dplyr)
library(forcats)
library(ggplot2)
library(kableExtra)
library(knitr)
library(RSQLite)
```

```{r db-connect}
con <- dbConnect(SQLite(), here::here("./data/ncdc.db"))
```

```{sql query, connection = con, output.var = "costliest_event_by_state"}
SELECT
  details.EPISODE_ID, 
  details.EVENT_ID, 
  details.STATE, 
  details.EVENT_TYPE, 
  MAX(details.DAMAGE_PROPERTY) AS MAX_DAMAGE, 
  details.BEGIN_LAT AS LAT, 
  details.BEGIN_LON AS LON, 
  episode_narratives.EPISODE_NARRATIVE
FROM
  details
LEFT JOIN 
  episode_narratives
ON details.EPISODE_ID = episode_narratives.EPISODE_ID
WHERE
  EVENT_TYPE IS NOT NULL AND
  STATE IS NOT NULL AND 
  LAT IS NOT NULL AND 
  LON IS NOT NULL
GROUP BY
  STATE;
```

```{r filter-dataset}
states <- map_data("state")

costliest_event_by_state <- 
  costliest_event_by_state %>% 
  filter(
    tolower(STATE) %in% states$region
  )

costliest_event_by_state$LON[costliest_event_by_state$STATE == "VIRGINIA"] <- -79.51
```

```{r plot, layout = "l-body-outset", fig.width = 10, fig.asp = 1, dpi = 150}
ggplot() + 
  geom_polygon(
    data = states, 
    aes(
      x = long, 
      y = lat, 
      group = group
    ), 
    fill = "white", 
    color = "gray60"
  ) + 
  geom_point(
    data = costliest_event_by_state, 
    aes(
      x = LON, 
      y = LAT, 
      color = EVENT_TYPE, 
      size = MAX_DAMAGE
    )
  ) + 
  scale_size_continuous(
    labels = scales::dollar, 
    range = c(3, 10)
  ) + 
  coord_map(
    projection = "albers", 
    lat0 = 39, 
    lat1 = 45
  ) + 
  theme(
    legend.position = "bottom", 
    # legend.direction = "vertical", 
    legend.box = "vertical", 
    panel.background = element_rect(fill = "white"), 
    axis.text = element_blank(), 
    axis.ticks = element_blank()
  ) + 
  guides(
    color = guide_legend(
      title = "Event Type", 
      title.position = "top", 
      title.hjust = 0.5, 
      # keywidth = unit(3, "cm"), 
      # keyheight = unit(3, "cm"), 
      override.aes = list(size = 3), 
      nrow = 1
    ), 
    size = guide_legend(
      title = "Damage (USD)", 
      title.position = "top", 
      title.hjust = 0.5
    )
  ) + 
  labs(
    title = "Costliest Event Type by US State", 
    x = "", 
    y = "", 
    caption = "@timtrice"
  )
```

```{r table, layout = "l-body-outset"}
costliest_event_by_state %>% 
  arrange(desc(MAX_DAMAGE)) %>% 
  select(STATE, EPISODE_NARRATIVE) %>% 
  slice(1L:5L) %>% 
  kable() %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover")
  )
```

```{r, ref.label = "libraries", eval = FALSE}
```

```{r, ref.label = "query", eval = FALSE}
```

```{r, ref.label = "filter-dataset", eval = FALSE}
```

```{r, ref.label = "plot", eval = FALSE}
```

```{r, ref.label = "table", eval = FALSE}
```

```{r db-disconnect}
dbDisconnect(con)
```
